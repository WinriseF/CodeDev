name: Update Prompt Library

on:
  schedule:
    - cron: '0 0 * * 1'
  workflow_dispatch:
  push:
    paths:
      - 'build/build_tldr.py'

permissions:
  contents: write

jobs:
  build-and-commit:
    runs-on: ubuntu-latest

    steps:
      # 1. æ‹‰å– GitHub ä»£ç  (æ­¤æ—¶åŒ…å« src, models, build ç­‰æ‰€æœ‰ä»£ç )
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main

      # 2. æ‹‰å– tldr æ•°æ®
      - name: Checkout Official Data
        uses: actions/checkout@v4
        with:
          repository: tldr-pages/tldr
          path: build/tldr
          sparse-checkout: |
            pages
            pages.zh
          fetch-depth: 1

      # 3. è®¾ç½® Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 4. è¿è¡Œè„šæœ¬ (ç”Ÿæˆæ•°æ®åˆ° build/dist)
      - name: Run ETL Script
        run: python build/build_tldr.py

      # 5. æäº¤ç”Ÿæˆçš„ JSON åˆ° GitHub (è¿™ä¸€æ­¥ä¿æŒä¸å˜ï¼ŒGitHub ä¾ç„¶ä¿ç•™å®Œæ•´ä»£ç )
      - name: Commit and Push to GitHub
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # ç¡®ä¿ build/dist è¢«æ·»åŠ åˆ° git (å³ä¾¿æ˜¯è¢«å¿½ç•¥çš„)
          git add -f build/dist
          
          if git diff --staged --quiet; then
            echo "âœ… GitHub: æ•°æ®æ²¡æœ‰å˜åŒ–ã€‚"
          else
            git commit -m "chore(data): auto-update tldr prompts [skip ci]"
            git push origin main
            echo "ğŸš€ GitHub: æ•°æ®å·²æ¨é€åˆ° main åˆ†æ”¯ï¼"
          fi

      # ----------------------------------------------------------------
      # 6. âœ¨ æ ¸å¿ƒä¿®æ”¹ï¼šçº¯å‡€åŒæ­¥ build å’Œ models åˆ° Gitee
      # ----------------------------------------------------------------
      - name: Sync Only build & models to Gitee
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          if [ -z "$GITEE_TOKEN" ]; then
            echo "âŒ Error: GITEE_TOKEN is not set."
            exit 1
          fi

          echo "ğŸ“¥ Cloning Gitee repo..."
          git clone https://oauth2:${GITEE_TOKEN}@gitee.com/winriseF/models.git gitee_workspace

          # --- A. æ¸…ç† Gitee ç›®å½• (å®ç°â€œåªæœ‰è¿™ä¸¤ä¸ªæ–‡ä»¶å¤¹â€) ---
          echo "ğŸ§¹ Cleaning Gitee workspace..."
          cd gitee_workspace
          # åˆ é™¤å½“å‰ç›®å½•ä¸‹é™¤äº† .git ç›®å½•ä»¥å¤–çš„æ‰€æœ‰æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
          # find . -maxdepth 1 -not -name '.git' -not -name '.' -exec rm -rf {} +
          # ä¸Šé¢å‘½ä»¤æ¯”è¾ƒå¤æ‚ï¼Œç”¨ git rm æ›´ç®€å•æš´åŠ›ï¼ˆåˆ é™¤æ‰€æœ‰è¢« git è¿½è¸ªçš„æ–‡ä»¶ï¼‰
          git rm -rf . --ignore-unmatch
          # æ¸…ç†å¯èƒ½æ®‹ç•™çš„æœªè¿½è¸ªæ–‡ä»¶
          git clean -fdx
          cd ..

          # --- B. å¤åˆ¶æŒ‡å®šæ–‡ä»¶å¤¹ ---
          echo "Dg Copying specific folders..."
          
          # 1. å¤åˆ¶ build (åŒ…å«è„šæœ¬å’Œç”Ÿæˆçš„ dist)
          # ç¡®ä¿ç›®æ ‡ç›®å½•ç»“æ„å­˜åœ¨
          mkdir -p gitee_workspace/build
          # å¤åˆ¶ build ä¸‹çš„æ‰€æœ‰å†…å®¹
          cp -r build/* gitee_workspace/build/
          
          # 2. å¤åˆ¶ models (ä½ çš„ json é…ç½®)
          mkdir -p gitee_workspace/models
          cp -r models/* gitee_workspace/models/
          
          # --- C. æäº¤å¹¶æ¨é€ ---
          cd gitee_workspace
          
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          # æ·»åŠ æ‰€æœ‰å˜æ›´ (åŒ…æ‹¬åˆ é™¤çš„æ–‡ä»¶å’Œæ–°å¤åˆ¶çš„æ–‡ä»¶)
          git add .

          if git diff --staged --quiet; then
            echo "âœ… Gitee: å†…å®¹ä¸ GitHub å®Œå…¨ä¸€è‡´ï¼Œæ— éœ€æ¨é€ã€‚"
          else
            echo "ğŸ“¦ Pushing clean state to Gitee..."
            git commit -m "chore(sync): sync build and models only [skip ci]"
            git push https://oauth2:${GITEE_TOKEN}@gitee.com/winriseF/models.git master
            echo "ğŸš€ Gitee: åŒæ­¥æˆåŠŸï¼ç°åœ¨ Gitee ä¸Šåªæœ‰ build å’Œ modelsã€‚"
          fi