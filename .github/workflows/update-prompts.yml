name: Update Prompt Library

on:
  schedule:
    - cron: '0 0 * * 1' # æ¯å‘¨ä¸€å›½é™…æ ‡å‡†æ—¶é—´ 0ç‚¹ è¿è¡Œ
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - 'build/**'      # å½“ build ç›®å½•æœ‰è„šæœ¬ä¿®æ”¹æ—¶è§¦å‘

permissions:
  contents: write

jobs:
  build-and-commit:
    runs-on: ubuntu-latest

    steps:
      # 1. æ‹‰å–ä»£ç 
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: main

      # 2. æ‹‰å– tldr å®˜æ–¹æ•°æ®
      - name: Checkout Official Tldr Data
        uses: actions/checkout@v4
        with:
          repository: tldr-pages/tldr
          path: build/tldr
          sparse-checkout: |
            pages
            pages.zh
          fetch-depth: 1

      # 3. è®¾ç½® Python ç¯å¢ƒ
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      # 4. å®‰è£…ä¾èµ– (Prompt è„šæœ¬éœ€è¦ requests)
      - name: Install Dependencies
        run: pip install requests

      # 5. è¿è¡Œ TLDR æ„å»ºè„šæœ¬ (ç”Ÿæˆ commands-*.json å’Œ manifest_tldr_partial.json)
      - name: Build Commands (Tldr)
        run: python build/build_tldr.py

      # 6. è¿è¡Œ Prompt æ„å»ºè„šæœ¬ (ç”Ÿæˆ prompts-*.json å’Œ manifest_prompts_partial.json)
      - name: Build Prompts (Roles)
        run: python build/build_prompts.py

      # 7. âœ¨ æ ¸å¿ƒæ­¥éª¤ï¼šåˆå¹¶æ¸…å• (Merge Manifests)
      # è¿™æ®µ Python è„šæœ¬ä¼šæ‰«ææ‰€æœ‰ *_partial.json å¹¶åˆå¹¶ä¸ºæœ€ç»ˆçš„ manifest.json
      - name: Merge Manifests
        run: |
          python -c "
          import json
          import os
          import time

          dist_dir = 'build/dist'
          packs_dir = os.path.join(dist_dir, 'packs')
          all_packages = []
          recorded_urls = set()

          print('ğŸ”„ Merging manifests and scanning directory structure...')

          # 1. åŠ è½½å®˜æ–¹è„šæœ¬ç”Ÿæˆçš„ partial json
          if os.path.exists(dist_dir):
              for f in os.listdir(dist_dir):
                  if f.endswith('_partial.json'):
                      path = os.path.join(dist_dir, f)
                      try:
                          with open(path, 'r', encoding='utf-8') as fp:
                              data = json.load(fp)
                              if isinstance(data, list):
                                  all_packages.extend(data)
                                  for item in data:
                                      recorded_urls.add(item.get('url'))
                                  print(f'  â• Added {len(data)} official packs from {f}')
                          os.remove(path)
                      except Exception as e:
                          print(f'  âŒ Error reading {f}: {e}')

          # 2. æ™ºèƒ½æ‰«æ packs æ–‡ä»¶å¤¹ç»“æ„
          if os.path.exists(packs_dir):
              for root, dirs, files in os.walk(packs_dir):
                  for filename in files:
                      if not filename.endswith('.json'):
                          continue

                      full_path = os.path.join(root, filename)
                      # è¿™é‡Œçš„ rel_path æ˜¯ manifest é‡Œçš„ä¸‹è½½åœ°å€ï¼Œä¿æŒä¸å˜
                      rel_path = os.path.relpath(full_path, dist_dir).replace('\\\\', '/')

                      if rel_path in recorded_urls:
                          continue

                      # === ğŸ“‚ è·¯å¾„è§£æé€»è¾‘ ===
                      # rel_from_packs ä¾‹å¦‚: 'prompts/zh/ä¸­æ–‡è§’è‰²æ‰®æ¼”ç²¾é€‰.json'
                      rel_from_packs = os.path.relpath(full_path, packs_dir).replace('\\\\', '/')
                      path_parts = rel_from_packs.split('/')

                      # é»˜è®¤å€¼
                      category = 'prompt'
                      lang = 'en'

                      # æ ¹æ®æ–‡ä»¶å¤¹å±‚çº§æ¨æ–­
                      if len(path_parts) >= 2:
                          # ç¬¬ä¸€å±‚: prompts æˆ– commands
                          folder_type = path_parts[0].lower()
                          if 'command' in folder_type:
                              category = 'command'
                          elif 'prompt' in folder_type:
                              category = 'prompt'

                          # ç¬¬äºŒå±‚: en æˆ– zh
                          folder_lang = path_parts[1].lower()
                          if 'zh' in folder_lang:
                              lang = 'zh'
                          elif 'en' in folder_lang:
                              lang = 'en'

                      try:
                          with open(full_path, 'r', encoding='utf-8') as fp:
                              content = json.load(fp)

                          if not isinstance(content, list):
                              print(f'  âš ï¸ Skipping {rel_path}: Root must be a list.')
                              continue

                          # === ğŸ·ï¸ å‘½åä¸IDé€»è¾‘ (æ›´æ–°ç‚¹) ===

                          # 1. åå­—ç›´æ¥ç”¨æ–‡ä»¶å (å»æ‰åç¼€)
                          # æ¯”å¦‚ 'ä¸­æ–‡è§’è‰²æ‰®æ¼”ç²¾é€‰.json' -> 'ä¸­æ–‡è§’è‰²æ‰®æ¼”ç²¾é€‰'
                          file_pure_name = os.path.splitext(filename)[0]

                          # 2. ç”Ÿæˆå”¯ä¸€ ID
                          # ä¸ºäº†é˜²æ­¢ä¸åŒæ–‡ä»¶å¤¹ä¸‹æœ‰åŒåæ–‡ä»¶å†²çªï¼ŒID åŠ ä¸Šå‰ç¼€
                          # æ¯”å¦‚ 'custom-prompt-zh-ä¸­æ–‡è§’è‰²æ‰®æ¼”ç²¾é€‰'
                          safe_id = f'custom-{category}-{lang}-{file_pure_name}'

                          new_pack = {
                              'id': safe_id,
                              'language': lang,
                              'platform': 'custom',
                              'name': file_pure_name,  # ç›´æ¥ä½¿ç”¨æ–‡ä»¶åä½œä¸ºæ˜¾ç¤ºåç§°
                              'description': f'{file_pure_name}',  # æè¿°ä¹Ÿé»˜è®¤ç”¨æ–‡ä»¶å
                              'count': len(content),
                              'size_kb': round(os.path.getsize(full_path) / 1024, 2),
                              'url': rel_path,
                              'category': category
                          }

                          all_packages.append(new_pack)
                          print(f'  ğŸ•µï¸ Auto-detected: {filename} -> Name: \"{file_pure_name}\"')

                      except Exception as e:
                          print(f'  âŒ Error processing {filename}: {e}')

          # 3. ç”Ÿæˆæœ€ç»ˆ Manifest
          final_manifest = {
              'updated_at': int(time.time() * 1000),
              'version': '2.1.0',
              'packages': all_packages
          }

          with open(os.path.join(dist_dir, 'manifest.json'), 'w', encoding='utf-8') as f:
              json.dump(final_manifest, f, indent=2, ensure_ascii=False)

          print(f'âœ… Final manifest created with {len(all_packages)} total packages.')
          "

      # 8. æäº¤ç»“æœåˆ° GitHub
      - name: Commit and Push to GitHub
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # å¼ºåˆ¶æ·»åŠ  dist ç›®å½• (å³ä½¿è¢« gitignore)
          git add -f build/dist
          
          if git diff --staged --quiet; then
            echo "âœ… GitHub: æ•°æ®æ²¡æœ‰å˜åŒ–ã€‚"
          else
            git commit -m "chore(data): auto-update prompts library [skip ci]"
            git push origin main
            echo "ğŸš€ GitHub: æ•°æ®å·²æ›´æ–°ï¼"
          fi

      # 9. åŒæ­¥åˆ° Gitee (ä¿æŒåŸæ ·ï¼Œçº¯å‡€åŒæ­¥ build å’Œ models)
      - name: Sync Only build & models to Gitee
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
        run: |
          if [ -z "$GITEE_TOKEN" ]; then
            echo "âŒ Error: GITEE_TOKEN is not set."
            exit 1
          fi

          echo "ğŸ“¥ Cloning Gitee repo..."
          git clone https://oauth2:${GITEE_TOKEN}@gitee.com/winriseF/models.git gitee_workspace

          echo "ğŸ§¹ Cleaning Gitee workspace..."
          cd gitee_workspace
          git rm -rf . --ignore-unmatch
          git clean -fdx
          cd ..

          echo "Dg Copying specific folders..."
          mkdir -p gitee_workspace/build
          cp -r build/* gitee_workspace/build/
          
          mkdir -p gitee_workspace/models
          cp -r models/* gitee_workspace/models/
          
          echo "ğŸ“„ Copying documentation files..."
          for file in README.md README.zh-CN.md USAGE.md USAGE_EN.md; do
            if [ -f "$file" ]; then
              cp "$file" gitee_workspace/
            fi
          done

          cd gitee_workspace
          git config user.name 'github-actions[bot]'
          git config user.email 'github-actions[bot]@users.noreply.github.com'

          git add .

          if git diff --staged --quiet; then
            echo "âœ… Gitee: å†…å®¹ä¸€è‡´ï¼Œæ— éœ€æ¨é€ã€‚"
          else
            echo "ğŸ“¦ Pushing clean state to Gitee..."
            git commit -m "chore(sync): sync build and models only [skip ci]"
            git push https://oauth2:${GITEE_TOKEN}@gitee.com/winriseF/models.git master
            echo "ğŸš€ Gitee: åŒæ­¥æˆåŠŸï¼"
          fi